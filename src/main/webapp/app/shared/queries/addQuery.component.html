<div class="top-page">
    <div class="page">
        <div class="block" style="align-items: center">
            <h1>Query Builder</h1>
            <div class="inputs">
                <div class="query_group">
                    <mat-label>Query Group Name</mat-label>
                    <input
                        matInput
                        [(ngModel)]="queryGrouName"
                        class="form-control"
                    />
                </div>
                <div class="query_group">
                    <mat-label>Query Group Description</mat-label>
                    <input
                        matInput
                        [(ngModel)]="queryGroupDesc"
                        class="form-control"
                    />
                </div>
            </div>

            <query-builder
                [(ngModel)]="query"
                [classNames]="bootstrapClassNames"
                [config]="currentConfig"
                [allowRuleset]="allowRuleset"
                [allowCollapse]="allowCollapse"
                [persistValueOnFieldChange]="persistValueOnFieldChange"
            >
                <div class="col-auto" *queryInput="let rule; type: 'textarea'">
                    <textarea
                        class="form-control"
                        [(ngModel)]="rule.value"
                        placeholder="Custom Textarea"
                    ></textarea>
                </div>
            </query-builder>
        </div>
        <!-- Content Group list cards -->
        <div class="row mb-4">
            <div
                class="col-md-4"
                *ngFor="let group of contentGroups; let i = index"
            >
                <div class="card position-relative cursor-pointer h-100">
                    <div
                        class="position-absolute d-flex flex-column align-items-end m-2"
                        style="top: 0; right: 0"
                    >
                        <div class="d-flex align-items-center" style="paddingBottom:15px;">
                            <small
                                [ngClass]="{
                                    'text-success': group.status === 'ACTIVE',
                                    'text-muted': group.status !== 'ACTIVE'
                                }"
                            >
                                {{
                                    group.status === "ACTIVE"
                                        ? "active"
                                        : "inactive"
                                }}
                            </small>
                            <div
                                class="custom-toggle me-2"
                                [class.active]="group.status === 'ACTIVE'"
                                (click)="onToggleStatus(group)"
                            >
                                <div class="toggle-circle"></div>
                            </div>
                        </div>

                        <button
                            class="btn btn-sm btn-danger mb-2"
                            (click)="deleteContentGroup(group.id)"
                        >
                            Delete
                        </button>
                    </div>

                    <div class="card-body" (click)="selectGroup(i)">
                        <h5 class="card-title">
                            {{ group.name || "Untitled Group" }}
                        </h5>
                        <p class="card-text text-muted">
                            {{ group.items?.length || 0 }} content item(s)
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Content Group Button -->
        <div class="block" *ngIf="!isEditingContent">
            <button class="btn btn-outline-primary" (click)="addContentGroup()">
                Add Content Group
            </button>
        </div>

        <div *ngIf="isEditingContent" class="mb-4 grey-background">
            <div class="p-3 border rounded shadow-sm">
                <label class="form-label fw-bold">Content Group Name</label>
                <input
                    type="text"
                    class="form-control mb-3"
                    [(ngModel)]="currentEditingCopy.name"
                    placeholder="Enter group name"
                />

                <query-content
                    [(items)]="currentEditingCopy.items"
                ></query-content>

                <div class="mt-3 d-flex">
                    <button
                        class="btn btn-primary mr-2"
                        (click)="saveCurrentEditingGroup()"
                    >
                        Save
                    </button>
                    <button
                        class="btn btn-secondary"
                        (click)="cancelEditContent()"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        <div *ngIf="groupNameError" class="alert alert-danger">
            <label>Query Group Name is required.</label>
        </div>

        <div *ngIf="groupNameDuplicateError" class="alert alert-danger">
            <label
                >The Query Group Name already exists, please use another
                name.</label
            >
        </div>

        <div *ngIf="groupDescError" class="alert alert-danger">
            <label>Query Group Description is required.</label>
        </div>

        <div *ngIf="queryBuilderError" class="alert alert-danger">
            <label>Please add at least one rule to the Query Builder.</label>
        </div>

        <div
            *ngIf="contentGroupNameError || contentGroupItemsError"
            class="alert alert-danger"
        >
            <label
                >All Content Groups must have a name and at least one content
                item.</label
            >
        </div>
        <div
            *ngIf="
                contentParagraphError ||
                queryRulesError ||
                contentModuleLinkError
            "
            class="alert alert-danger"
        >
            <label>Please fill in all fields.</label>
        </div>

        <button (click)="saveQueryGroupToDB()" class="btn btn-primary saveBtn">
            Save
        </button>
    </div>
</div>
